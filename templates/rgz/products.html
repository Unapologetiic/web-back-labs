{% extends "base.html" %}

{% block lab %}Расчетно-графическое задание - Товары{% endblock %}

{% block main %}
    <div class="user-info">
        <h2>Управление товарами на складе</h2>
        <p>Текущий пользователь: {{ session.get('warehouse_full_name', 'Гость') }}</p>
    </div>

    <div class="warehouse-nav">
        <a href="/rgz" class="btn btn-secondary">Главная</a>
        <a href="/rgz/orders" class="btn btn-secondary">Заказы</a>
        <a href="/rgz/cart" class="btn btn-secondary">Корзина</a>
        <a href="/rgz/profile" class="btn btn-secondary">Профиль</a>
    </div>

    <div class="content-container">
        <!-- Форма добавления товара -->
        <div class="card">
            <h3>Добавить/Обновить товар</h3>
            <form id="addProductForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="article">Артикул:</label>
                        <input type="text" id="article" name="article" required 
                               pattern="[A-Za-z0-9_-]{3,50}"
                                title="Только латинские буквы, цифры, дефисы и подчеркивания (3-50 символов)">
                    </div>
                    
                    <div class="form-group">
                        <label for="name">Название:</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="quantity">Количество:</label>
                        <input type="number" id="quantity" name="quantity" 
                               min="0" value="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="price">Цена (руб.):</label>
                        <input type="number" id="price" name="price" 
                               min="0" step="0.01" value="0.00" required>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Добавить/Обновить</button>
            </form>
        </div>

        <!-- Список товаров -->
        <div class="card">
            <h3>Список товаров на складе</h3>
            <div id="productsList"></div>
            <div id="loading">Загрузка...</div>
            <button id="loadMore" class="btn btn-secondary" style="display: none;">
                Загрузить еще
            </button>
        </div>
        
    </div>

    <script>
        let currentPage = 1;
        let hasMore = true;
        
        // Загрузка товаров
        async function loadProducts() {
            const response = await fetch(`/rgz/api/products?page=${currentPage}`);
            const data = await response.json();
            
            const productsList = document.getElementById('productsList');
            const loading = document.getElementById('loading');
            const loadMoreBtn = document.getElementById('loadMore');
            
            if (currentPage === 1) {
                productsList.innerHTML = '';
            }
            
            if (data.products.length === 0) {
                loading.innerHTML = 'Товаров не найдено';
                loadMoreBtn.style.display = 'none';
                return;
            }
            
            loading.style.display = 'none';
            
            // Отображение товаров
            data.products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product-item';
                productDiv.innerHTML = `
                    <div class="product-info">
                        <h4>${product.name}</h4>
                        <p><strong>Артикул:</strong> ${product.article}</p>
                        <p><strong>Количество:</strong> ${product.quantity} шт.</p>
                        <p><strong>Цена:</strong> ${product.price.toFixed(2)} руб.</p>
                    </div>
                    <div class="product-actions">
                        <button onclick="addToCart(${product.id})" 
                                class="btn btn-small btn-primary"
                                ${product.quantity === 0 ? 'disabled' : ''}>
                            В корзину
                        </button>
                        <button onclick="deleteProduct(${product.id})" 
                                class="btn btn-small btn-danger">
                            Удалить
                        </button>
                    </div>
                `;
                productsList.appendChild(productDiv);
            });
            
            // Кнопка "Загрузить еще"
            hasMore = data.has_next;
            if (hasMore) {
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
        
        // Добавление товара
        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            
            const response = await fetch('/rgz/api/products', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                e.target.reset();
                currentPage = 1;
                loadProducts();
            } else {
                alert('Ошибка: ' + result.error);
            }
        });
        // Удаление товара
        async function deleteProduct(productId, productName) {
            if (!confirm(`Вы уверены, что хотите удалить товар "${productName}"?\nЭто действие невозможно отменить.`)) return;
        
            
            const response = await fetch(`/rgz/api/products/${productId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentPage = 1;
                loadProducts();
            } else {
                alert('Ошибка: ' + result.error);
            }
        }
        
        // Добавление в корзину
        async function addToCart(productId) {
            const quantity = prompt('Введите количество:', '1');
            if (!quantity || isNaN(quantity) || quantity <= 0) return;
            
            const formData = new FormData();
            formData.append('product_id', productId);
            formData.append('quantity', quantity);
            
            const response = await fetch('/rgz/api/cart', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`Добавлено ${result.quantity} шт. в корзину`);
            } else {
                alert('Ошибка: ' + result.error);
            }
        }
        
        // Кнопка "Загрузить еще"
        document.getElementById('loadMore').addEventListener('click', () => {
            currentPage++;
            loadProducts();
        });
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', loadProducts);
    </script>

    <style>
        .warehouse-nav {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .content-container {
            display: grid;
            gap: 30px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .product-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8fafc;
        }
        
        .product-info h4 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }
        
        .product-info p {
            margin: 5px 0;
            color: #718096;
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
        }
        
        #loading {
            text-align: center;
            padding: 20px;
            color: #718096;
        }
    </style>
{% endblock %}